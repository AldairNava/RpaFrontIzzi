<div class="text-900 font-bold text-2xl mb-4 text-center" style="background-color: rgb(51, 133, 241);color: white !important;">Reprocesar Cuentas Sin Validacion</div>
    <div class="grid flex justify-content-center text-center">
        <div class="col-4" [formGroup]="formReproceso">
            <p-card header="Fecha de Captura" subheader="Seleccionar un intervalo de fechas" [style]="{ width: '360px' }">
                <div class="p-fluid p-formgrid grid">
                    <div class="field col-12 md:col-12" >
                        <span class="p-float-label"> 
                        <p-calendar [showIcon]="true" formControlName="fecha" dateFormat="dd-mm-yy" selectionMode="range"  inputId="icon">
                        </p-calendar>
                        <label for="inputdate">Fechas de Busqueda</label>
                        </span>
                    </div>
                </div>
                <ng-template pTemplate="footer">
                <button mat-button pButton (click)="buscar()" style="width:auto; background-color: rgb(51, 133, 241);border: 0;" label="Buscar" ></button>
                </ng-template>
            </p-card>    
        </div>
    </div>
<div class="row" >
    <div class="cols">
      <div class="card">
        <p-table #dt1 [value]="showtable" dataKey="Caso de negocio" [rows]="50" [rowHover]="true" [rowsPerPageOptions]="[50,100,500,1000]"
            styleClass="p-datatable-gridlines" [paginator]="true"
            responsiveLayout="scroll" [globalFilterFields]="['cuenta','casoNegocio','categoria','estado','motivos']">
            <ng-template pTemplate="header">
                <tr>
                    <th >
                        <div class="flex justify-content-center align-items-center text-center">
                            Estatus
                        </div>
                    </th>  
                    <th >
                        <div class="flex justify-content-center align-items-center text-center">
                            Total
                        </div>
                    </th>
                    <th >
                        <div class="flex justify-content-center align-items-center text-center">
                            Acciones
                        </div>
                    </th> 
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr>
                    <td class="text-center">
                        {{item.groupedStatus}}
                    </td>
                    <td class="text-center">
                        {{item.totalCount}}
                    </td>
                    <td class="text-center">
                        <button pButton  style="background-color:rgb(51, 133, 241);border: 0;" label="Reprocesar" (click)="confirm1(item.groupedStatus)" ></button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="7">Sin Datos para Mostrar.</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="loadingbody">
                <tr>
                    <td colspan="7">Cargando Datos, espere...</td>
                </tr>

            </ng-template>
            <ng-template pTemplate="paginatorleft" let-state>
                Mostrando {{(state.page  * state.rows) + 1}} a {{state.rows * (state.page + 1)}} de {{state.totalRecords}} registros.
          </ng-template>
        </p-table>
      </div>
    </div>
</div>

 <div class="card mt-4" *ngIf="isAdmin">
    <p-tabView>
        <p-tabPanel header="Reproceso">
            -<div class="flex flex-column align-items-center justify-content-center" style="min-height: 150px;">
                    <p-selectButton 
                    [options]="tipoReprocesoOptions" 
                    [(ngModel)]="tipoReproceso" 
                    optionLabel="label"
                    optionValue="value"
                    styleClass="mb-3">
                    </p-selectButton>
                    <div *ngIf="tipoReproceso === 'individual'" class="mt-3 w-25 flex flex-column align-items-center">
                        <label for="idInput" class="mb-2 font-bold">ID</label>
                        <input
                            pInputText
                            id="idInput"
                            [(ngModel)]="idIndividual"
                            pattern="[0-9]*"
                            onlyNumbers
                            maxlength="20"
                        />
                        <button
                            pButton
                            label="Reprocesar"
                            class="mt-3"
                            style="background-color:rgb(51, 133, 241);border: 0;"
                            [disabled]="!idIndividual"
                            (click)="confirmarReprocesoIndividual()"
                        ></button>
                        </div>
                <p-dialog
                    header="Confirmación"
                    [(visible)]="displayConfirm"
                    [modal]="true"
                    [closable]="false"
                    [baseZIndex]="10000"
                    >
                    <div class="flex flex-column align-items-center">
                        <i class="pi pi-question-circle mb-3" style="font-size: 2rem"></i>
                        <div class="mb-3">
                        ¿La cuenta a reprocesar es correcta?
                        <strong>{{ idIndividual || '' }}</strong>
                        </div>
                        <div class="flex gap-2 justify-content-center">
                        <button
                            pButton
                            label="No"
                            icon="pi pi-times"
                            class="p-button-text"
                            (click)="displayConfirm = false"
                        ></button>
                        <button
                            pButton
                            label="Sí"
                            icon="pi pi-check"
                            (click)="reprocesarIndividual()"
                            autofocus
                        ></button>
                        </div>
                    </div>
                </p-dialog>
                
                <div *ngIf="tipoReproceso === 'masivo'" class="mt-3 w-25 flex flex-column align-items-center">
                    <label for="fileInput" class="mb-2 font-bold">Archivo a Reprocesar</label>
                    <label for="fileInput" 
                        style="background-color:rgb(51, 133, 241); color:white; border-radius:4px; padding:8px 16px; cursor:pointer; display:inline-block; margin-bottom: 10px;">
                        Seleccionar archivo
                        <input
                            type="file"
                            id="fileInput"
                            accept=".xlsx,.csv"
                            (change)="onFileChange($event)"
                            style="display:none"
                        />
                    </label>
                    <button
                        pButton
                        label="Reprocesar Masivo"
                        class="mt-3"
                        style="background-color:rgb(51, 133, 241);border: 0;"
                        [disabled]="!fileToUpload"
                        (click)="confirmarReprocesoMasivo()"
                    ></button>
                    </div>

                    <p-dialog
                    header="Confirmación Masiva"
                    [(visible)]="displayConfirmMasivo"
                    [modal]="true"
                    [closable]="false"
                    [baseZIndex]="10000"
                    >
                    <div class="flex flex-column align-items-center">
                        <i class="pi pi-question-circle mb-3" style="font-size: 2rem"></i>
                        <div class="mb-3">
                        ¿Deseas reprocesar <strong>{{ idsFromFile.length }}</strong> cuentas?
                        </div>
                        <div class="flex gap-2 justify-content-center">
                        <button
                            pButton
                            label="No"
                            icon="pi pi-times"
                            class="p-button-text"
                            (click)="displayConfirmMasivo = false"
                        ></button>
                        <button
                            pButton
                            label="Sí"
                            icon="pi pi-check"
                            (click)="reprocesarMasivo()"
                            autofocus
                        ></button>
                        </div>
                    </div>
                </p-dialog>

            </div>
        </p-tabPanel>
      <p-tabPanel header="Cambio Status">
        <!-- ...dentro de <p-tabPanel header="Cambio Status"> ... -->
        <div class="flex flex-column align-items-center justify-content-center" style="min-height: 150px;">
        <p-selectButton
            [options]="tipoCambioStatusOptions"
            [(ngModel)]="tipoCambioStatus"
            optionLabel="label"
            optionValue="value"
            styleClass="mb-3"
        ></p-selectButton>

        <!-- Individual -->
        <div *ngIf="tipoCambioStatus === 'individual'" class="mt-3 w-25 flex flex-column align-items-center">
            <label for="idStatusInput" class="mb-2 font-bold">ID</label>
            <input
            pInputText
            id="idStatusInput"
            [(ngModel)]="idCambioStatus"
            pattern="[0-9]*"
            inputmode="numeric"
            maxlength="20"
            onlyNumbers
            />
            <label for="statusDropdown" class="mb-2 font-bold mt-3">Estatus</label>
            <p-dropdown
            id="statusDropdown"
            [options]="estatusOptions"
            [(ngModel)]="estatusSeleccionado"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecciona un estatus"
            style="width: 100%;"
            class="mb-3"
            ></p-dropdown>
            <button
            pButton
            label="Cambiar Status"
            class="mt-3"
            style="background-color:rgb(51, 133, 241);border: 0;"
            [disabled]="!idCambioStatus || !estatusSeleccionado"
            (click)="confirmarCambioStatusIndividual()"
            ></button>
        </div>

        <!-- Dialogo Confirmación Individual -->
        <p-dialog
            header="Confirmación"
            [(visible)]="displayConfirmCambioStatus"
            [modal]="true"
            [closable]="false"
            [baseZIndex]="10000"
        >
            <div class="flex flex-column align-items-center">
            <i class="pi pi-question-circle mb-3" style="font-size: 2rem"></i>
            <div class="mb-3">
                ¿Cambiar el status de la cuenta <strong>{{ idCambioStatus }}</strong> a <strong>{{ estatusSeleccionado }}</strong>?
            </div>
            <div class="flex gap-2 justify-content-center">
                <button
                pButton
                label="No"
                icon="pi pi-times"
                class="p-button-text"
                (click)="displayConfirmCambioStatus = false"
                ></button>
                <button
                pButton
                label="Sí"
                icon="pi pi-check"
                (click)="cambiarStatusIndividual()"
                autofocus
                ></button>
            </div>
            </div>
        </p-dialog>

        <!-- Masivo -->
        <div *ngIf="tipoCambioStatus === 'masivo'" class="mt-3 w-25 flex flex-column align-items-center">
            <label for="fileInputStatus" class="mb-2 font-bold">Archivo a Procesar</label>
            <label for="fileInputStatus"
            style="background-color:rgb(51, 133, 241); color:white; border-radius:4px; padding:8px 16px; cursor:pointer; display:inline-block; margin-bottom: 10px;">
            Seleccionar archivo
            <input
                type="file"
                id="fileInputStatus"
                accept=".xlsx,.csv"
                (change)="onFileChangeStatus($event)"
                style="display:none"
            />
            </label>
            <button
            pButton
            label="Cambiar Status Masivo"
            class="mt-3"
            style="background-color:rgb(51, 133, 241);border: 0;"
            [disabled]="!fileToUploadStatus"
            (click)="confirmarCambioStatusMasivo()"
            ></button>
        </div>

        <!-- Dialogo Confirmación Masivo -->
        <p-dialog
            header="Confirmación Masiva"
            [(visible)]="displayConfirmCambioStatusMasivo"
            [modal]="true"
            [closable]="false"
            [baseZIndex]="10000"
        >
            <div class="flex flex-column align-items-center">
            <i class="pi pi-question-circle mb-3" style="font-size: 2rem"></i>
            <div class="mb-3">
                ¿Deseas cambiar el status de <strong>{{ idsStatusFromFile.length }}</strong> cuentas?
            </div>
            <div class="flex gap-2 justify-content-center">
                <button
                pButton
                label="No"
                icon="pi pi-times"
                class="p-button-text"
                (click)="displayConfirmCambioStatusMasivo = false"
                ></button>
                <button
                pButton
                label="Sí"
                icon="pi pi-check"
                (click)="cambiarStatusMasivo()"
                autofocus
                ></button>
            </div>
            </div>
        </p-dialog>
        </div>
      </p-tabPanel>
    </p-tabView>
  </div>

<p-toast
  [baseZIndex]="99999"
  key="tst"></p-toast>

  <div class="card flex justify-content-center gap-2">
    <p-toast></p-toast>
    <p-confirmDialog [style]="{width: '50vw'}" acceptLabel="Sí" rejectLabel="No" rejectButtonStyleClass="p-button-outlined p-button-warning" acceptButtonStyleClass="p-button-warning"></p-confirmDialog>
  </div>


